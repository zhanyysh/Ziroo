# Архитектура Карты (2GIS Style)

Этот документ описывает логику работы интерактивной карты в приложении.

## 1. Концепция: "Окно в мир" (Viewport Loading)
Мы не загружаем всю базу данных сразу. Мы загружаем только то, что видит пользователь.

- **Логика**:
  1. Пользователь сдвинул карту.
  2. Приложение ждет паузу (300-500мс), чтобы не делать лишних запросов (**Debouncing**).
  3. Приложение берет координаты углов экрана: `North`, `South`, `East`, `West`.
  4. Отправляет запрос: `get_branches_in_view(min_lat, max_lat...)`.
  5. Получает список и отрисовывает его.

## 2. Уровни детализации (LOD - Level of Detail)
Карта "умнее", чем кажется. Она скрывает лишнее на, чтобы не засорять экран.

| Zoom карты | Уровень (LOD) | Что показываем | Приоритет в БД |
|------------|--------------|----------------|-----------------|
| < 12 (Далеко) | Город / Район | Только ТЦ (Large) | `1` |
| 12 - 15 (Средне) | Район / Квартал | ТЦ + Супермаркеты | `1`, `2` |
| > 15 (Близко) | Улица | Всё (вкл. киоски) | `1`, `2`, `3` |

**Техническая реализация**:
В базе данных у каждого филиала есть поле `map_priority` (int). Функция `get_branches_in_view` фильтрует данные на стороне сервера.

## 3. Кластеризация (Группировка)
*Сейчас не реализована, но запланирована.*
Если в одной точке 50 магазинов, карта должна объединить их в кружок с цифрой "50".
Для реализации во Flutter используется пакет `flutter_map_marker_cluster`.

## 4. Поиск "Рядом"
Логика кнопки "Рядом":
1. Карта перемещается к координатам пользователя (`_currentPosition`).
2. Это автоматически вызывает событие "смена позиции".
3. Срабатывает логика **Viewport Loading** (пункт 1).
4. Загружаются магазины вокруг пользователя.

## 5. Синхронизация списка
Список снизу экрана (`ListView`) отображает тот же массив данных (`_filteredBranches`), что и карта.
Если магазин пропал с карты (ушел за экран), он пропадет и из списка.

---

## SQL Функция (Server-Side Logic)
Вся "магия" фильтрации происходит внутри функции `get_branches_in_view` в Supabase.

```sql
SELECT * FROM company_branches 
WHERE 
  latitude BETWEEN min_lat AND max_lat  -- Внутри экрана по вертикали
  AND longitude BETWEEN min_lng AND max_lng -- Внутри экрана по горизонтали
  AND map_priority <= target_priority; -- Подходящий размер для текущего зума
```
